<!DOCTYPE html>
<html>
<head>
    <title>Image Resizer (WASM)</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 40px auto; padding: 0 20px; }
        input, select, button { margin: 5px 0; }
        #status { color: #666; margin: 10px 0; }
        #result { margin-top: 20px; }
        #result img { max-width: 100%; border: 1px solid #ccc; }
        .error { color: red; }
        button:disabled { opacity: 0.5; }
        .quality-row { display: none; }
        .quality-row.show { display: block; }
        .size-info { background: #f5f5f5; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Image Resizer</h1>
    <p id="status">Loading WASM...</p>

    <form id="form">
        <p>
            <label>Image: <input type="file" id="image" accept="image/*" required></label>
            <span id="inputSize"></span>
        </p>
        <p>
            <label>Width: <input type="number" id="width" placeholder="e.g. 200"></label>
        </p>
        <p>
            <label>Height: <input type="number" id="height" placeholder="e.g. 200"></label>
        </p>
        <p>
            <label>Output format:
                <select id="format">
                    <option value="png">PNG</option>
                    <option value="jpeg">JPEG</option>
                </select>
            </label>
        </p>
        <p class="quality-row" id="qualityRow">
            <label>Quality: <input type="range" id="quality" min="1" max="100" value="90">
            <span id="qualityValue">90</span>%</label>
        </p>
        <p>
            <label><input type="checkbox" id="trim"> Trim borders (transparent or solid color)</label>
        </p>
        <p>
            <button type="submit" id="submit" disabled>Resize</button>
        </p>
    </form>
    <p><small>Supports PNG, JPEG, and WebP input. Leave width or height empty to maintain aspect ratio.</small></p>
    <p><small>All processing happens in your browser - no server upload.</small></p>

    <div id="result"></div>

    <script src="wasm_exec.js"></script>
    <script>
        const go = new Go();
        let wasmReady = false;

        // Format file size for display
        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        WebAssembly.instantiateStreaming(fetch("main.wasm"), go.importObject)
            .then((result) => {
                go.run(result.instance);
                wasmReady = true;
                document.getElementById("status").textContent = "Ready";
                document.getElementById("submit").disabled = false;
            })
            .catch((err) => {
                document.getElementById("status").innerHTML =
                    '<span class="error">Failed to load WASM: ' + err.message + '</span>';
            });

        // Show/hide quality slider based on format
        document.getElementById("format").addEventListener("change", (e) => {
            const qualityRow = document.getElementById("qualityRow");
            if (e.target.value === "jpeg") {
                qualityRow.classList.add("show");
            } else {
                qualityRow.classList.remove("show");
            }
        });

        // Update quality value display
        document.getElementById("quality").addEventListener("input", (e) => {
            document.getElementById("qualityValue").textContent = e.target.value;
        });

        // Show input file size
        document.getElementById("image").addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (file) {
                document.getElementById("inputSize").textContent = `(${formatSize(file.size)})`;
            }
        });

        document.getElementById("form").addEventListener("submit", async (e) => {
            e.preventDefault();

            if (!wasmReady) {
                alert("WASM not loaded yet");
                return;
            }

            const fileInput = document.getElementById("image");
            const file = fileInput.files[0];
            if (!file) {
                alert("Please select an image");
                return;
            }

            const status = document.getElementById("status");
            status.textContent = "Processing...";

            try {
                // Read file as ArrayBuffer
                const arrayBuffer = await file.arrayBuffer();
                const uint8Array = new Uint8Array(arrayBuffer);

                // Get options
                const width = parseInt(document.getElementById("width").value) || 0;
                const height = parseInt(document.getElementById("height").value) || 0;
                const trim = document.getElementById("trim").checked;
                const format = document.getElementById("format").value;
                const quality = parseInt(document.getElementById("quality").value) || 90;

                // Call WASM function
                const result = processImage(uint8Array, width, height, trim, format, quality);

                if (result.error) {
                    throw new Error(result.error);
                }

                // Create blob and display result
                const blob = new Blob([result.data], { type: result.mimeType });
                const url = URL.createObjectURL(blob);

                const ext = format === "jpeg" ? "jpg" : "png";
                const savings = file.size > result.size
                    ? `<span style="color: green">(-${formatSize(file.size - result.size)})</span>`
                    : `<span style="color: orange">(+${formatSize(result.size - file.size)})</span>`;

                document.getElementById("result").innerHTML = `
                    <div class="size-info">
                        <strong>Output:</strong> ${result.width} x ${result.height} &bull; ${formatSize(result.size)} ${savings}
                    </div>
                    <img src="${url}" alt="Resized image">
                    <p><a href="${url}" download="resized.${ext}">Download</a></p>
                `;

                status.textContent = "Done!";
            } catch (err) {
                status.innerHTML = '<span class="error">Error: ' + err.message + '</span>';
                document.getElementById("result").innerHTML = '';
            }
        });
    </script>
</body>
</html>
